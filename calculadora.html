<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulador de Consumo â€“ Casa inteira AvanÃ§ado</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
* {font-family: 'Inter', system-ui, -apple-system, sans-serif;}
:root{--bg:#0f172a;--card:rgba(255,255,255,0.04);--accent:#ffd866;}
body{background:linear-gradient(135deg,#0b1220,#0f172a 25%, #1e1b4b 50%, #0f172a 75%, #0b1220);background-size: 400% 400%;animation: gradientShift 20s ease infinite;color:#e6eef8;}
@keyframes gradientShift {0%, 100% { background-position: 0% 50%; }50% { background-position: 100% 50%; }}
.glass{background:rgba(255,255,255,0.05);backdrop-filter:blur(12px);border: 1px solid rgba(255,255,255,0.1);box-shadow: 0 8px 32px rgba(0,0,0,0.1);}
.card-hover{transition:transform .3s cubic-bezier(0.23, 1, 0.32, 1), box-shadow .3s, background .3s;}
.card-hover:hover{transform:translateY(-8px);box-shadow:0 20px 60px rgba(2,6,23,0.5);background:rgba(255,255,255,0.08);}
input.editable{background:rgba(255,255,255,0.08);border:1px solid rgba(255,216,102,0.3);border-radius:8px;padding:8px 10px;color:#e6eef8;width:100%;transition: all 0.3s ease;}
input.editable:focus{outline:none;box-shadow:0 0 0 3px rgba(250,204,21,0.3);border-color:rgba(250,204,21,0.7);background:rgba(255,255,255,0.14);transform: scale(1.02);}
#tarifa{width:150px;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,216,102,0.3);color:#e6eef8;transition: all 0.3s ease;font-weight: 600;}
#tarifa:focus{outline:none;box-shadow:0 0 0 3px rgba(250,204,21,0.3);border-color:rgba(250,204,21,0.7);background:rgba(255,255,255,0.14);}
canvas{background:rgba(255,255,255,0.02);border-radius:16px;padding: 12px;}
.btn-small{padding:.6rem 1rem;font-size:.875rem;cursor:pointer;border-radius: 10px;font-weight: 600;transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);border: 1px solid transparent;}
.btn-small:hover {transform: translateY(-2px);box-shadow: 0 8px 20px rgba(0,0,0,0.3);}
.btn-small:active {transform: translateY(0);}
.table-input{background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.15);color:inherit;padding:6px 8px;text-align:center;border-radius:6px;transition: all 0.2s ease;}
.table-input.nome{text-align:left;}
.table-input[type="number"]{width:70px;}
.table-input:focus{outline:none;border-color:rgba(250,204,21,0.5);background:rgba(15,23,42,0.8);box-shadow: 0 0 0 2px rgba(250,204,21,0.2);}
.kwh{color:#10b981;font-weight:600;font-size: 0.95rem;}
#tableAparelhos td{text-align:center;vertical-align:middle;padding: 12px 8px;}
#tableAparelhos thead th {padding: 12px 8px;font-weight: 700;letter-spacing: 0.5px;}
#tableAparelhos tbody tr {transition: background 0.2s ease;}
#tableAparelhos tbody tr:hover {background: rgba(255,255,255,0.04);}
#graficoGeral,#graficoBarras{height:400px !important;}
@media (max-width:900px){#graficoGeral,#graficoBarras{height:300px !important;}}
.no-print{display:block;}
.room-btn {position: relative;overflow: hidden;}
.room-btn::before {content: '';position: absolute;top: 50%;left: 50%;width: 0;height: 0;border-radius: 50%;background: rgba(250, 204, 21, 0.2);transform: translate(-50%, -50%);transition: width 0.4s, height 0.4s;}
.room-btn:hover::before {width: 200px;height: 200px;}
.room-btn span {position: relative;z-index: 1;}
.preset-item {background: rgba(255,255,255,0.03);border: 1px solid rgba(255,255,255,0.1);border-radius: 8px;padding: 10px;transition: all 0.3s ease;}
.preset-item:hover {background: rgba(255,255,255,0.06);border-color: rgba(250,204,21,0.3);transform: translateX(4px);}
nav {backdrop-filter: blur(20px);border-bottom: 1px solid rgba(255,255,255,0.1);}
nav a {position: relative;transition: color 0.3s ease;cursor:pointer;}
nav a::after {content: '';position: absolute;bottom: -4px;left: 0;width: 0;height: 2px;background: #facc15;transition: width 0.3s ease;}
nav a:hover::after {width: 100%;}
.stat-value {font-size: 1.5rem;font-weight: 800;background: linear-gradient(135deg, #10b981, #34d399);-webkit-background-clip: text;-webkit-text-fill-color: transparent;background-clip: text;}
.lightning {animation: lightning-flash 2s ease-in-out infinite;}
@keyframes lightning-flash {0%, 100% { opacity: 1; }50% { opacity: 0.7; }}
.badge {display: inline-flex;align-items: center;gap: 6px;padding: 6px 12px;border-radius: 20px;font-size: 0.75rem;font-weight: 600;border: 1px solid;}
.badge-info {background: rgba(59, 130, 246, 0.1);border-color: rgba(59, 130, 246, 0.3);color: #3b82f6;}
@keyframes float {0%, 100% { transform: translateY(0); }50% { transform: translateY(-6px); }}
.float-icon {animation: float 3s ease-in-out infinite;}
.section-header {display: flex;align-items: center;gap: 12px;margin-bottom: 16px;}
.section-header .icon {font-size: 1.75rem;filter: drop-shadow(0 0 10px rgba(250, 204, 21, 0.5));}
.glow {box-shadow: 0 0 30px rgba(250, 204, 21, 0.2);}
* {scroll-behavior: smooth;}
.btn-gradient-amber {background: linear-gradient(135deg, #fbbf24, #f59e0b);color: #0f172a;border: 1px solid rgba(251, 191, 36, 0.5);}
.btn-gradient-amber:hover {background: linear-gradient(135deg, #f59e0b, #fbbf24);box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);}
.btn-gradient-emerald {background: linear-gradient(135deg, #10b981, #059669);color: white;}
.btn-gradient-emerald:hover {background: linear-gradient(135deg, #059669, #10b981);box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);}
.btn-gradient-indigo {background: linear-gradient(135deg, #6366f1, #4f46e5);color: white;}
.btn-gradient-indigo:hover {background: linear-gradient(135deg, #4f46e5, #6366f1);}
.btn-gradient-rose {background: linear-gradient(135deg, #f43f5e, #e11d48);color: white;}
.btn-gradient-rose:hover {background: linear-gradient(135deg, #e11d48, #f43f5e);}
.tab-content{display:none;}
.tab-content.active{display:block;}
#graficoRelatorioPizza,
#graficoRelatorioBarras {
  width: 100% !important;
  height: 320px !important;
  display: block;
}

#relatorio .grid.md\:grid-cols-2 {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
  gap: 24px !important;
  align-items: start !important;
}
</style>
</head>
<body>
<div class="max-w-7xl mx-auto p-6">
<nav class="flex items-center justify-between mb-8 glass p-5 rounded-xl sticky top-4 z-50">
  <div class="flex items-center gap-3">
    <h1 class="text-xl font-bold text-amber-400 lightning flex items-center gap-2">
      <span class="text-2xl">âš¡</span> Simulador de Consumo
    </h1>
    <span class="badge badge-info">AvanÃ§ado</span>
  </div>
  <div class="flex items-center gap-6 text-sm font-medium no-print">
  <a href="index.html" class="hover:text-amber-400">ğŸ  InÃ­cio</a>
    <a href="#" class="text-amber-400 font-semibold">âš™ï¸ Calculadora</a>
    <a href="instrucoes.html" class="hover:text-amber-400">ğŸ“˜ InstruÃ§Ãµes</a>
    <a href="dicas.html" class="hover:text-amber-400">ğŸ’¡ Dicas</a>
    <button id="btnVerRelatorio" class="btn-small btn-gradient-indigo flex items-center gap-2">
      <span>ğŸ“Š</span> Ver RelatÃ³rio Geral
    </button>
  </div>
</nav>
<div id="calculadora" class="tab-content active">
<header class="flex flex-col md:flex-row items-start justify-between mb-8 gap-4">
  <div>
    <h2 class="text-3xl font-extrabold mb-2 bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">
      Simulador de Consumo â€“ Casa inteira
    </h2>
    <p class="text-slate-300 mt-2 text-lg">Selecione um cÃ´modo, ajuste aparelhos e veja impacto em kWh e em R$.</p>
  </div>
  <div class="text-right no-print">
    <div class="text-sm text-slate-400 mb-2 font-medium">ğŸ’° Tarifa (R$/kWh)</div>
    <div class="flex items-center gap-3">
      <input id="tarifa" type="number" step="0.001" value="0.970" />
      <button id="gerarPDF" class="btn-small btn-gradient-emerald flex items-center gap-2">
        <span>ğŸ“„</span> Gerar PDF
      </button>
    </div>
  </div>
</header>

<div class="mb-8 flex flex-wrap gap-3 no-print">
  <button class="room-btn btn-small bg-slate-700 hover:bg-slate-600" data-room="Sala">
    <span>ğŸ›‹ï¸ Sala</span>
  </button>
  <button class="room-btn btn-small bg-slate-700 hover:bg-slate-600" data-room="Quarto">
    <span>ğŸ›ï¸ Quarto</span>
  </button>
  <button class="room-btn btn-small bg-slate-700 hover:bg-slate-600" data-room="Cozinha">
    <span>ğŸ³ Cozinha</span>
  </button>
  <button class="room-btn btn-small bg-slate-700 hover:bg-slate-600" data-room="Banheiro">
    <span>ğŸš¿ Banheiro</span>
  </button>
  <button class="room-btn btn-small bg-slate-700 hover:bg-slate-600" data-room="Lavanderia">
    <span>ğŸ‘• Lavanderia</span>
  </button>
</div>

<section class="grid md:grid-cols-2 gap-6 mb-8">
  <div class="p-6 glass rounded-2xl card-hover">
    <div class="section-header">
      <span class="icon float-icon">ğŸ“¦</span>
      <h3 id="roomTitle" class="font-bold text-xl text-amber-400">Sala</h3>
    </div>
    <p class="text-sm text-slate-400 mb-4">Aparelhos prÃ©-definidos â€“ clique em <em>Importar</em> para adicionar.</p>
    <div id="presetsList" class="space-y-2 mb-5"></div>
    <div class="flex gap-3 flex-wrap">
      <button id="btnAddManual" class="btn-small btn-gradient-indigo">â• Adicionar manual</button>
      <button id="btnClearRoom" class="btn-small btn-gradient-rose">ğŸ—‘ï¸ Limpar</button>
      <button id="btnSaveRoom" class="btn-small bg-slate-700 hover:bg-slate-600">ğŸ’¾ Salvar</button>
    </div>
  </div>

  <div class="p-6 glass rounded-2xl card-hover glow">
    <div class="section-header">
      <span class="icon float-icon">ğŸ“Š</span>
      <h4 class="font-bold text-xl text-slate-100">Resumo do ambiente</h4>
    </div>
    <div class="space-y-4 text-sm">
      <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg">
        <span class="text-slate-300">âš¡ Consumo total</span>
        <strong id="consumoTotal" class="stat-value">0,00 kWh</strong>
      </div>
      <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg">
        <span class="text-slate-300">ğŸ’µ Custo estimado</span>
        <strong id="custoTotal" class="text-xl font-bold text-amber-400">R$ 0,00</strong>
      </div>
      <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg">
        <span class="text-slate-300">ğŸ”Œ Aparelhos</span>
        <strong id="qtdAparelhos" class="text-xl font-bold text-blue-400">0</strong>
      </div>
      <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg">
        <span class="text-slate-300">ğŸ• Horas mÃ©dias/dia</span>
        <strong id="horasMedia" class="text-xl font-bold text-purple-400">0</strong>
      </div>
    </div>
    <div class="mt-5 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
      <p class="text-slate-300 text-xs flex items-center gap-2">
        <span>ğŸ’¾</span> Dados salvos localmente no navegador.
      </p>
    </div>
  </div>
</section>

<section class="p-6 glass rounded-2xl card-hover mb-8">
<div class="section-header">
  <span class="icon float-icon">ğŸ“‹</span>
  <h3 class="font-bold text-xl text-amber-400">Tabela de Aparelhos</h3>
</div>
<div class="overflow-x-auto">
<table id="tableAparelhos" class="min-w-full text-sm mt-4">
<thead class="text-slate-300 text-left text-xs uppercase border-b border-slate-700">
<tr>
<th class="pb-3">ğŸ·ï¸ Nome</th>
<th class="pb-3">âš¡ PotÃªncia (W)</th>
<th class="pb-3">#ï¸âƒ£ Quantidade</th>
<th class="pb-3">ğŸ•— Horas/dia</th>
<th class="pb-3">â³ Minutos/dia</th>
<th class="pb-3">ğŸ’š kWh/mÃªs</th>
<th class="pb-3">ğŸ”§ AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbody" class="align-top"></tbody>
</table>
</div>
<div class="mt-6 flex flex-wrap items-center gap-3">
  <button id="btnCalcular" class="btn-small btn-gradient-amber">ğŸ§® Calcular</button>
  <button id="btnExportCsv" class="btn-small bg-slate-700 hover:bg-slate-600">ğŸ“¥ Exportar CSV</button>
  <button id="btnResetHours" class="btn-small bg-slate-700 hover:bg-slate-600">â±ï¸ Zerar horas</button>
  <button id="btnToggleGraph" class="btn-small btn-gradient-emerald">ğŸ“Š Modo: kWh</button>
</div>
</section>

<section class="p-6 glass rounded-2xl card-hover mb-8 grid md:grid-cols-2 gap-6">
<div>
  <div class="section-header">
    <span class="icon float-icon">ğŸ¥§</span>
    <h4 id="chartTitle" class="font-bold text-lg text-amber-400">GrÃ¡fico de Pizza (kWh/mÃªs)</h4>
  </div>
  <canvas id="graficoGeral"></canvas>
</div>
<div>
  <div class="section-header">
    <span class="icon float-icon">ğŸ“Š</span>
    <h4 id="chartBarTitle" class="font-bold text-lg text-amber-400">GrÃ¡fico de Barras (kWh/mÃªs)</h4>
  </div>
  <canvas id="graficoBarras"></canvas>
</div>
</section>
</div>
<div id="relatorio" class="tab-content">
<header class="mb-8">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-3xl font-extrabold mb-2 bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">
        ğŸ“Š RelatÃ³rio Geral - Toda a Casa
      </h2>
      <p class="text-slate-300 mt-2 text-lg">VisÃ£o consolidada do consumo de energia de todos os cÃ´modos</p>
    </div>
    <button id="btnVoltarCalc" class="btn-small bg-slate-700 hover:bg-slate-600 flex items-center gap-2">
      <span>â¬…ï¸</span> Voltar
    </button>
  </div>
</header>

<section class="grid md:grid-cols-4 gap-4 mb-8">
  <div class="p-6 glass rounded-2xl card-hover text-center">
    <div class="text-4xl mb-3">âš¡</div>
    <div class="text-sm text-slate-400 mb-2">Consumo Total</div>
    <div id="relatorioConsumoTotal" class="stat-value text-2xl">0,00 kWh</div>
  </div>
  <div class="p-6 glass rounded-2xl card-hover text-center">
    <div class="text-4xl mb-3">ğŸ’°</div>
    <div class="text-sm text-slate-400 mb-2">Custo Total</div>
    <div id="relatorioCustoTotal" class="text-2xl font-bold text-amber-400">R$ 0,00</div>
  </div>
  <div class="p-6 glass rounded-2xl card-hover text-center">
    <div class="text-4xl mb-3">ğŸ </div>
    <div class="text-sm text-slate-400 mb-2">CÃ´modos</div>
    <div id="relatorioComodos" class="text-2xl font-bold text-blue-400">5</div>
  </div>
  <div class="p-6 glass rounded-2xl card-hover text-center">
    <div class="text-4xl mb-3">ğŸ”Œ</div>
    <div class="text-sm text-slate-400 mb-2">Total de Aparelhos</div>
    <div id="relatorioAparelhos" class="text-2xl font-bold text-purple-400">0</div>
  </div>
</section>

<section class="p-6 glass rounded-2xl card-hover mb-8">
  <div class="section-header">
    <span class="icon float-icon">ğŸ“Š</span>
    <h3 class="font-bold text-xl text-amber-400">Consumo por CÃ´modo</h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm mt-4" id="tabelaRelatorio">
      <thead class="text-slate-300 text-left text-xs uppercase border-b border-slate-700">
        <tr>
          <th class="pb-3 px-4">ğŸ  CÃ´modo</th>
          <th class="pb-3 px-4 text-right">âš¡ kWh/mÃªs</th>
          <th class="pb-3 px-4 text-right">ğŸ’° R$/mÃªs</th>
          <th class="pb-3 px-4 text-right">ğŸ“Š % do Total</th>
          <th class="pb-3 px-4 text-center">ğŸ”Œ Aparelhos</th>
        </tr>
      </thead>
      <tbody id="tbodyRelatorio"></tbody>
    </table>
  </div>
</section>

<section class="p-6 glass rounded-2xl card-hover mb-8">
  <div class="section-header">
    <span class="icon float-icon">ğŸ“ˆ</span>
    <h3 class="font-bold text-xl text-amber-400">AnÃ¡lise Visual de Consumo</h3>
  </div>
  <div class="grid md:grid-cols-2 gap-6">
    <div>
      <h4 class="text-center text-sm text-slate-400 mb-4 font-semibold">DistribuiÃ§Ã£o por CÃ´modo - Pizza (kWh)</h4>
      <canvas id="graficoRelatorioPizza" style="height:350px !important;"></canvas>
    </div>
    <div>
      <h4 class="text-center text-sm text-slate-400 mb-4 font-semibold">Comparativo por CÃ´modo - Barras (kWh)</h4>
      <canvas id="graficoRelatorioBarras" style="height:350px !important;"></canvas>
    </div>
  </div>
</section>
<section class="p-6 glass rounded-2xl card-hover mb-8">
  <div class="section-header">
    <span class="icon float-icon">ğŸ”</span>
    <h3 class="font-bold text-xl text-amber-400">Top 10 Aparelhos - Maior Consumo</h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm mt-4">
      <thead class="text-slate-300 text-left text-xs uppercase border-b border-slate-700">
        <tr>
          <th class="pb-3 px-4">PosiÃ§Ã£o</th>
          <th class="pb-3 px-4">ğŸ·ï¸ Aparelho</th>
          <th class="pb-3 px-4">ğŸ  CÃ´modo</th>
          <th class="pb-3 px-4 text-right">âš¡ PotÃªncia (W)</th>
          <th class="pb-3 px-4 text-right">ğŸ• Horas/dia</th>
          <th class="pb-3 px-4 text-right">ğŸ’š kWh/mÃªs</th>
          <th class="pb-3 px-4 text-right">ğŸ’° R$/mÃªs</th>
        </tr>
      </thead>
      <tbody id="tbodyTop10"></tbody>
    </table>
  </div>
</section>

<div class="flex justify-center gap-4 mb-8">
  <button id="btnGerarPDFRelatorio" class="btn-small btn-gradient-emerald flex items-center gap-2">
    <span>ğŸ“„</span> Gerar PDF Executivo
  </button>
  <button id="btnExportRelatorioCSV" class="btn-small btn-gradient-amber flex items-center gap-2">
    <span>ğŸ“¥</span> Exportar CSV Detalhado
  </button>
</div>
</div>

<footer class="text-sm text-slate-400 text-center py-4 border-t border-slate-700/50">
  <p class="mb-1">âš¡ Desenvolvido por EletromÃ¡gicos â€“ 2025</p>
  <p class="text-xs text-slate-500">Ferramenta educativa para simulaÃ§Ã£o de consumo energÃ©tico</p>
</footer>

</div>

<template id="rowTemplate">
<tr class="border-t border-slate-700/30">
<td class="py-3"><input class="nome table-input editable" placeholder="Nome do aparelho" /></td>
<td class="py-3"><input class="potencia table-input editable" type="number" step="1" placeholder="60" /></td>
<td class="py-3"><input class="qtd table-input editable" type="number" step="1" placeholder="1" /></td>
<td class="py-3"><input class="horas table-input editable" type="number" step="1" placeholder="0" /></td>
<td class="py-3"><input class="minutos table-input editable" type="number" step="1" placeholder="0" /></td>
<td class="py-3"><span class="kwh">0,00</span></td>
<td class="py-3">
  <button class="remover btn-small btn-gradient-rose">ğŸ—‘ï¸ Remover</button>
</td>
</tr>
</template>

<script>
const PRESETS = {
'Sala': [
{name:'TV LED 55"', w:120, h:4, m:0, q:1},
{name:'Ar-condicionado 12k BTU', w:1000, h:2, m:0, q:1},
{name:'Ventilador', w:60, h:3, m:0, q:1},
{name:'Soundbar', w:40, h:1.5, m:0, q:1},
{name:'LÃ¢mpada LED 12W', w:12, h:5, m:0, q:4}
],
'Quarto': [
{name:'LÃ¢mpada LED', w:12, h:4, m:0, q:2},
{name:'Ventilador', w:60, h:8, m:0, q:1},
{name:'TV 32"', w:80, h:1.5, m:0, q:1},
{name:'Carregador (celular)', w:10, h:2, m:0, q:1},
{name:'Computador desktop', w:300, h:6, m:0, q:1},
{name:'Monitor', w:40, h:6, m:0, q:1},
{name:'Impressora', w:100, h:0.5, m:0, q:1},
],
'Cozinha': [
{name:'Geladeira (mÃ©dia)', w:200, h:24, m:0, q:1},
{name:'Micro-ondas', w:1000, h:0, m:12, q:1},
{name:'Forno elÃ©trico', w:1500, h:0, m:30, q:1},
{name:'Cooktop', w:2000, h:0, m:30, q:1},
{name:'LÃ¢mpada LED', w:12, h:4, m:0, q:2}
],
'Banheiro': [
{name:'Chuveiro (elÃ©trico)', w:5500, h:0, m:12, q:1},
{name:'Secador de cabelo', w:1200, h:0, m:3, q:1},
{name:'LÃ¢mpada LED', w:12, h:1, m:0, q:1}
],
'Lavanderia': [
{name:'MÃ¡quina de lavar', w:500, h:1, m:0, q:1},
{name:'Secadora', w:2000, h:0, m:30, q:1},
{name:'Ferro de passar', w:1200, h:0, m:12, q:1}
]
};

const roomBtns = document.querySelectorAll('.room-btn');
const roomTitle = document.getElementById('roomTitle');
const presetsList = document.getElementById('presetsList');
const tbody = document.getElementById('tbody');
const rowTemplate = document.getElementById('rowTemplate');
const tarifaInput = document.getElementById('tarifa');
const consumoTotalEl = document.getElementById('consumoTotal');
const custoTotalEl = document.getElementById('custoTotal');
const qtdAparelhosEl = document.getElementById('qtdAparelhos');
const horasMediaEl = document.getElementById('horasMedia');
const btnAddManual = document.getElementById('btnAddManual');
const btnClearRoom = document.getElementById('btnClearRoom');
const btnSaveRoom = document.getElementById('btnSaveRoom');
const btnCalcular = document.getElementById('btnCalcular');
const btnExportCsv = document.getElementById('btnExportCsv');
const btnResetHours = document.getElementById('btnResetHours');
const btnToggleGraph = document.getElementById('btnToggleGraph');
const gerarPDFBtn = document.getElementById('gerarPDF');
const chartTitleEl = document.getElementById('chartTitle');
const chartBarTitleEl = document.getElementById('chartBarTitle');
const graficoCanvas = document.getElementById('graficoGeral');
const graficoBarrasCanvas = document.getElementById('graficoBarras');

let currentRoom = localStorage.getItem('sim_selectedRoom') || 'Sala';
let graphMode = localStorage.getItem('sim_graphMode') || 'kwh';
let chartInstance=null;
let chartBarInstance=null;
let chartRelatorioPizzaInstance=null;
let chartRelatorioBarrasInstance=null;

const money=v=>Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function formatNumberBR(x){return Number(x).toFixed(2).replace('.',',');}

function addRow(name='',potencia=60,qtd=1,horas=1,minutos=0){
const frag=rowTemplate.content.cloneNode(true);
const tr=frag.querySelector('tr');
tr.querySelector('.nome').value=name;
tr.querySelector('.potencia').value=potencia;
tr.querySelector('.qtd').value=qtd;
tr.querySelector('.horas').value=horas;
tr.querySelector('.minutos').value=minutos;
tr.querySelector('.kwh').textContent=calcKwhForInputs(tr);
tr.querySelector('.remover').addEventListener('click',()=>{tr.remove();updateAll();});
['nome','potencia','qtd','horas','minutos'].forEach(cls=>{
  tr.querySelector('.'+cls).addEventListener('input',()=>{tr.querySelector('.kwh').textContent=calcKwhForInputs(tr);updateAll();});
});
tbody.appendChild(tr);
updateAll();
}

function calcKwhForInputs(tr){
const pot=Number(tr.querySelector('.potencia').value||0);
const qtd=Number(tr.querySelector('.qtd').value||0);
const horas=Number(tr.querySelector('.horas').value||0);
const minutos=Number(tr.querySelector('.minutos').value||0);
const horasTotais = horas + (minutos / 60);
return formatNumberBR((pot*horasTotais*30*qtd)/1000);
}

function gatherRows(){
const rows=[];
tbody.querySelectorAll('tr').forEach(tr=>{
  const nome=tr.querySelector('.nome').value||'â€”';
  const potencia=Number(tr.querySelector('.potencia').value||0);
  const qtd=Number(tr.querySelector('.qtd').value||0);
  const horas=Number(tr.querySelector('.horas').value||0);
  const minutos=Number(tr.querySelector('.minutos').value||0);
  const horasTotais = horas + (minutos / 60);
  const kwh=(potencia*horasTotais*30*qtd)/1000;
  rows.push({nome,potencia,qtd,horas,minutos,kwh});
});
return rows;
}

function saveRoom(room){
const all=JSON.parse(localStorage.getItem('sim_rooms')||'{}');
all[room]=gatherRows();
localStorage.setItem('sim_rooms',JSON.stringify(all));
}

function loadRoom(room){
const all=JSON.parse(localStorage.getItem('sim_rooms')||'{}');
return all[room]||null;
}

function renderPresets(room){
presetsList.innerHTML='';
(PRESETS[room]||[]).forEach(p=>{
  const div=document.createElement('div');
  div.className='preset-item flex items-center justify-between text-sm';
  div.innerHTML=`<span class="text-slate-300"><strong>${p.name}</strong> â€“ ${p.w}W</span><button class="btn-small bg-slate-700 hover:bg-slate-600 import-preset">â• Importar</button>`;
  presetsList.appendChild(div);
  div.querySelector('.import-preset').addEventListener('click',()=>addRow(p.name,p.w,p.q||1,p.h||1,p.m||0));
});
}

function switchRoom(room){
saveRoom(currentRoom);
currentRoom=room;
localStorage.setItem('sim_selectedRoom',currentRoom);
roomBtns.forEach(b=>{
  b.classList.remove('bg-amber-400','text-slate-900');
  b.classList.add('bg-slate-700');
  if(b.dataset.room===room){
    b.classList.remove('bg-slate-700');
    b.classList.add('bg-amber-400','text-slate-900');
  }
});
roomTitle.textContent=room;
renderPresets(room);
tbody.innerHTML='';
const saved=loadRoom(room);
if(saved&&saved.length){
  saved.forEach(r=>addRow(r.nome,r.potencia,r.qtd,r.horas,r.minutos||0));
}else{
  (PRESETS[room]||[]).forEach(d=>addRow(d.name,d.w,d.q||1,d.h||1,d.m||0));
}
updateAll();
}

function updateSummary(){
const rows=gatherRows();
const totalKwh=rows.reduce((s,r)=>s+r.kwh,0);
const tarifa=Number(tarifaInput.value||0);
const totalReais=totalKwh*tarifa;
const mediaHoras=(rows.length?rows.reduce((s,r)=>s+(r.horas+(r.minutos/60)),0)/rows.length:0).toFixed(1);
consumoTotalEl.textContent=totalKwh.toFixed(2).replace('.',',')+' kWh';
custoTotalEl.textContent=money(totalReais);
qtdAparelhosEl.textContent=rows.length;
horasMediaEl.textContent=mediaHoras;
saveRoom(currentRoom);
}

function updateCharts(){
const rows=gatherRows();
const labels=rows.map(r=>r.nome);
const tarifa=Number(tarifaInput.value||0);
const data=rows.map(r=>graphMode==='kwh'?Number(r.kwh.toFixed(2)):Number((r.kwh*tarifa).toFixed(2)));

chartTitleEl.textContent=graphMode==='kwh'?'GrÃ¡fico de Pizza (kWh/mÃªs)':'GrÃ¡fico de Pizza (R$/mÃªs)';
btnToggleGraph.innerHTML=graphMode==='kwh'?'ğŸ“Š Modo: kWh':'ğŸ’° Modo: R$';
if(chartInstance){chartInstance.destroy();chartInstance=null;}
if(labels.length){
chartInstance=new Chart(graficoCanvas.getContext('2d'),{
type:'pie',
data:{labels,datasets:[{data,backgroundColor:labels.map((_,i)=>`hsl(${(i*50)%360} 70% 50%)`),borderColor:'#0b1220',borderWidth:2}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:16,padding:10,font:{size:13,family:'Inter'}}},tooltip:{callbacks:{label:function(c){const val=c.parsed;if(graphMode==='kwh')return`${c.label}: ${Number(val).toFixed(2).replace('.',',')} kWh`;return`${c.label}: ${money(val)}`;}}}}}
});
}else{
  const ctx=graficoCanvas.getContext('2d');
  ctx.clearRect(0,0,graficoCanvas.width,graficoCanvas.height);
}

chartBarTitleEl.textContent=graphMode==='kwh'?'GrÃ¡fico de Barras (kWh/mÃªs)':'GrÃ¡fico de Barras (R$/mÃªs)';
if(chartBarInstance){chartBarInstance.destroy();chartBarInstance=null;}
if(labels.length){
chartBarInstance=new Chart(graficoBarrasCanvas.getContext('2d'),{
type:'bar',
data:{labels,datasets:[{label:graphMode==='kwh'?'kWh':'R$',data,backgroundColor:labels.map((_,i)=>`hsl(${(i*50)%360} 70% 50%)`),borderRadius:8}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.1)'}},x:{grid:{display:false}}}}
});
}else{
  const ctx=graficoBarrasCanvas.getContext('2d');
  ctx.clearRect(0,0,graficoBarrasCanvas.width,graficoBarrasCanvas.height);
}
}

function exportCSV(){
const rows=gatherRows();
if(!rows.length){alert('Nenhum aparelho para exportar.');return;}
const tarifa=Number(tarifaInput.value||0);
let csv='RELATORIO DE CONSUMO - COMODO: '+currentRoom+'\n';
csv+='Data: '+new Date().toLocaleDateString('pt-BR')+'\n';
csv+='Tarifa: R$ '+tarifa.toFixed(3)+'/kWh\n\n';
csv+='Nome do Aparelho;Potencia (W);Quantidade;Horas/dia;Minutos/dia;Consumo (kWh/mes);Custo (R$/mes)\n';
rows.forEach(r=>{
  const custo=(r.kwh*tarifa).toFixed(2);
  csv+=`${r.nome};${r.potencia};${r.qtd};${r.horas};${r.minutos};${r.kwh.toFixed(2)};${custo}\n`;
});
const totalKwh=rows.reduce((s,r)=>s+r.kwh,0);
const totalCusto=totalKwh*tarifa;
csv+='\nTOTAL;;;;;'+totalKwh.toFixed(2)+';'+totalCusto.toFixed(2)+'\n';
const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`relatorio_${currentRoom}_${new Date().toISOString().slice(0,10)}.csv`;
a.click();
URL.revokeObjectURL(url);
}

function updateAll(){
  tbody.querySelectorAll('tr').forEach(tr=>tr.querySelector('.kwh').textContent=calcKwhForInputs(tr));
  updateSummary();
  updateCharts();
}

function getAllRoomsData(){
const rooms=['Sala','Quarto','Cozinha','Banheiro','Lavanderia'];
const data=[];
rooms.forEach(room=>{
  const saved=loadRoom(room);
  if(saved&&saved.length){
    const totalKwh=saved.reduce((s,r)=>s+r.kwh,0);
    data.push({room,rows:saved,totalKwh,count:saved.length});
  }else{
    data.push({room,rows:[],totalKwh:0,count:0});
  }
});
return data;
}
function updateRelatorio(){
const allRooms=getAllRoomsData();
const tarifa=Number(tarifaInput.value||0);
const totalKwhCasa=allRooms.reduce((s,d)=>s+d.totalKwh,0);
const totalCustoCasa=totalKwhCasa*tarifa;
const totalAparelhosCasa=allRooms.reduce((s,d)=>s+d.count,0);

document.getElementById('relatorioConsumoTotal').textContent=totalKwhCasa.toFixed(2).replace('.',',')+' kWh';
document.getElementById('relatorioCustoTotal').textContent=money(totalCustoCasa);
document.getElementById('relatorioComodos').textContent='5';
document.getElementById('relatorioAparelhos').textContent=totalAparelhosCasa;

const tbodyRel=document.getElementById('tbodyRelatorio');
tbodyRel.innerHTML='';
allRooms.forEach(data=>{
  const custo=data.totalKwh*tarifa;
  const perc=totalKwhCasa>0?(data.totalKwh/totalKwhCasa*100).toFixed(1):0;
  const tr=document.createElement('tr');
  tr.className='border-t border-slate-700/30';
  tr.innerHTML=`
    <td class="py-3 px-4 font-semibold">${data.room}</td>
    <td class="py-3 px-4 text-right text-green-400 font-bold">${data.totalKwh.toFixed(2).replace('.',',')} kWh</td>
    <td class="py-3 px-4 text-right text-amber-400 font-bold">${money(custo)}</td>
    <td class="py-3 px-4 text-right text-blue-400">${perc}%</td>
    <td class="py-3 px-4 text-center">${data.count}</td>
  `;
  tbodyRel.appendChild(tr);
});

const labelsRoom=allRooms.map(d=>d.room);
const dataKwh=allRooms.map(d=>Number(d.totalKwh.toFixed(2)));
const colors=['#f59e0b','#3b82f6','#10b981','#8b5cf6','#ec4899'];

const canvasPizza=document.getElementById('graficoRelatorioPizza');
const canvasBarras=document.getElementById('graficoRelatorioBarras');

if(chartRelatorioPizzaInstance){chartRelatorioPizzaInstance.destroy();}
chartRelatorioPizzaInstance=new Chart(canvasPizza.getContext('2d'),{
  type:'pie',
  data:{labels:labelsRoom,datasets:[{data:dataKwh,backgroundColor:colors,borderColor:'#0b1220',borderWidth:2}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:12,family:'Inter'},padding:12}},tooltip:{callbacks:{label:c=>`${c.label}: ${Number(c.parsed).toFixed(2).replace('.',',')} kWh`}}}}
});

if(chartRelatorioBarrasInstance){chartRelatorioBarrasInstance.destroy();}
chartRelatorioBarrasInstance=new Chart(canvasBarras.getContext('2d'),{
  type:'bar',
  data:{labels:labelsRoom,datasets:[{label:'Consumo (kWh)',data:dataKwh,backgroundColor:colors,borderRadius:8}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.1)'},ticks:{font:{size:11}}},x:{grid:{display:false},ticks:{font:{size:11}}}}}
});

const allAparelhos=[];
allRooms.forEach(roomData=>{
  roomData.rows.forEach(row=>{
    allAparelhos.push({nome:row.nome,room:roomData.room,potencia:row.potencia,horas:row.horas,minutos:row.minutos,kwh:row.kwh,custo:row.kwh*tarifa});
  });
});
allAparelhos.sort((a,b)=>b.kwh-a.kwh);
const top10=allAparelhos.slice(0,10);

const tbodyTop10=document.getElementById('tbodyTop10');
tbodyTop10.innerHTML='';
top10.forEach((ap,i)=>{
  const horasTotais=(ap.horas+(ap.minutos/60)).toFixed(1);
  const tr=document.createElement('tr');
  tr.className='border-t border-slate-700/30';
  tr.innerHTML=`
    <td class="py-3 px-4 font-bold text-amber-400 text-center">${i+1}Âº</td>
    <td class="py-3 px-4">${ap.nome}</td>
    <td class="py-3 px-4">${ap.room}</td>
    <td class="py-3 px-4 text-right font-semibold">${ap.potencia}W</td>
    <td class="py-3 px-4 text-right">${horasTotais}h</td>
    <td class="py-3 px-4 text-right text-green-400 font-semibold">${ap.kwh.toFixed(2).replace('.',',')} kWh</td>
    <td class="py-3 px-4 text-right text-amber-400 font-semibold">${money(ap.custo)}</td>
  `;
  tbodyTop10.appendChild(tr);
});
}

function exportRelatorioCSV(){
const allRooms=getAllRoomsData();
const tarifa=Number(tarifaInput.value||0);
const totalKwhCasa=allRooms.reduce((s,d)=>s+d.totalKwh,0);
const totalCustoCasa=totalKwhCasa*tarifa;

let csv='========================================\n';
csv+='RELATORIO COMPLETO DE CONSUMO DE ENERGIA\n';
csv+='========================================\n';
csv+='Data de Emissao: '+new Date().toLocaleDateString('pt-BR')+'\n';
csv+='Tarifa Aplicada: R$ '+tarifa.toFixed(3)+'/kWh\n';
csv+='Consumo Total: '+totalKwhCasa.toFixed(2)+' kWh/mes\n';
csv+='Custo Total: R$ '+totalCustoCasa.toFixed(2)+'/mes\n';
csv+='========================================\n\n';

csv+='RESUMO POR COMODO\n';
csv+='Comodo;Consumo (kWh/mes);Custo (R$/mes);Percentual;Qtd Aparelhos\n';
allRooms.forEach(roomData=>{
  const custo=(roomData.totalKwh*tarifa).toFixed(2);
  const perc=totalKwhCasa>0?(roomData.totalKwh/totalKwhCasa*100).toFixed(1):0;
  csv+=`${roomData.room};${roomData.totalKwh.toFixed(2)};${custo};${perc}%;${roomData.count}\n`;
});

csv+='\n========================================\n';
csv+='DETALHAMENTO POR APARELHO\n';
csv+='========================================\n';
allRooms.forEach(roomData=>{
  if(roomData.rows.length>0){
    csv+='\n--- '+roomData.room.toUpperCase()+' ---\n';
    csv+='Aparelho;Potencia (W);Quantidade;Horas/dia;Minutos/dia;Consumo (kWh/mes);Custo (R$/mes)\n';
    roomData.rows.forEach(row=>{
      const custo=(row.kwh*tarifa).toFixed(2);
      csv+=`${row.nome};${row.potencia};${row.qtd};${row.horas};${row.minutos};${row.kwh.toFixed(2)};${custo}\n`;
    });
    csv+='Subtotal '+roomData.room+':;;;;;'+roomData.totalKwh.toFixed(2)+';'+(roomData.totalKwh*tarifa).toFixed(2)+'\n';
  }
});

csv+='\n========================================\n';
csv+='TOTAL GERAL:;;;;;'+totalKwhCasa.toFixed(2)+';'+totalCustoCasa.toFixed(2)+'\n';
csv+='========================================\n';

const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download='relatorio_completo_casa_'+new Date().toISOString().slice(0,10)+'.csv';
a.click();
URL.revokeObjectURL(url);
}

// ============================================
// FUNÃ‡ÃƒO PARA GERAR PDF EXECUTIVO PROFISSIONAL (MELHORADO)
// ============================================
async function gerarPDFExecutivo() {
  try {
    // Salvar cÃ´modo atual antes de gerar relatÃ³rio
    saveRoom(currentRoom);
    
    // Coletar todos os dados
    const allRooms = getAllRoomsData();
    const tarifa = Number(tarifaInput.value || 0);
    const totalKwhCasa = allRooms.reduce((s, d) => s + d.totalKwh, 0);
    const totalCustoCasa = totalKwhCasa * tarifa;
    const totalAparelhosCasa = allRooms.reduce((s, d) => s + d.count, 0);
    
    // Coletar top 10 aparelhos
    const allAparelhos = [];
    allRooms.forEach(roomData => {
      roomData.rows.forEach(row => {
        allAparelhos.push({
          nome: row.nome,
          room: roomData.room,
          potencia: row.potencia,
          horas: row.horas,
          minutos: row.minutos,
          kwh: row.kwh,
          custo: row.kwh * tarifa
        });
      });
    });
    allAparelhos.sort((a, b) => b.kwh - a.kwh);
    const top10 = allAparelhos.slice(0, 10);
    
    // Identificar pontos de atenÃ§Ã£o
    const pontosAtencao = [];
    if (totalKwhCasa > 500) {
      pontosAtencao.push('Consumo total acima de 500 kWh/mes - considere revisar os equipamentos de maior consumo.');
    }
    if (top10.length > 0 && top10[0].kwh > totalKwhCasa * 0.3) {
      pontosAtencao.push(`O aparelho "${top10[0].nome}" representa mais de 30% do consumo total.`);
    }
    
    // Calcular economia potencial (estimativa de 15% com otimizaÃ§Ã£o)
    const economiaPotencial = totalCustoCasa * 0.15;
    
    // Criar novo documento PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    
    // ============================================
    // PÃGINA 1: CAPA EXECUTIVA
    // ============================================
    
    // Fundo gradiente simulado com retÃ¢ngulos
    doc.setFillColor(15, 23, 42);
    doc.rect(0, 0, pageWidth, pageHeight, 'F');
    
    // Borda decorativa superior
    doc.setFillColor(251, 191, 36);
    doc.rect(0, 0, pageWidth, 8, 'F');
    
    // Ãcone de raio (simulado com forma geomÃ©trica)
    doc.setFillColor(251, 191, 36);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(251, 191, 36);
    doc.text('ENERGIA', pageWidth / 2, 55, { align: 'center' });
    
    // TÃ­tulo principal
    doc.setFontSize(32);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(251, 191, 36);
    doc.text('RELATORIO EXECUTIVO', pageWidth / 2, 85, { align: 'center' });
    
    // SubtÃ­tulo
    doc.setFontSize(20);
    doc.setTextColor(226, 232, 240);
    doc.text('Analise de Consumo Energetico', pageWidth / 2, 100, { align: 'center' });
    
    // Linha decorativa
    doc.setDrawColor(251, 191, 36);
    doc.setLineWidth(1);
    doc.line(pageWidth / 2 - 30, 110, pageWidth / 2 + 30, 110);
    
    // DescriÃ§Ã£o
    doc.setFontSize(12);
    doc.setTextColor(203, 213, 225);
    doc.setFont('helvetica', 'normal');
    const descTexto = 'Diagnostico Completo de Eficiencia Energetica\nResidencial e Oportunidades de Economia';
    const descLines = doc.splitTextToSize(descTexto, pageWidth - 80);
    doc.text(descLines, pageWidth / 2, 130, { align: 'center' });
    
    // InformaÃ§Ãµes da capa
    doc.setFontSize(10);
    doc.setTextColor(148, 163, 184);
    const dataAtual = new Date().toLocaleDateString('pt-BR', { 
      day: '2-digit', 
      month: 'long', 
      year: 'numeric' 
    });
    
    // Box de informaÃ§Ãµes
    const infoY = pageHeight - 60;
    doc.setDrawColor(71, 85, 105);
    doc.setLineWidth(0.5);
    doc.line(margin, infoY, pageWidth - margin, infoY);
    
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(251, 191, 36);
    doc.text('Data de Emissao:', margin, infoY + 10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(203, 213, 225);
    doc.text(dataAtual, margin, infoY + 17);
    
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(251, 191, 36);
    doc.text('Periodo de Analise:', pageWidth - margin, infoY + 10, { align: 'right' });
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(203, 213, 225);
    doc.text('Mensal (30 dias)', pageWidth - margin, infoY + 17, { align: 'right' });
    
    // RodapÃ©
    doc.setFontSize(9);
    doc.setTextColor(100, 116, 139);
    doc.setFont('helvetica', 'bold');
    doc.text('Eletromagicos Energy Solutions (c) 2025', pageWidth / 2, pageHeight - 25, { align: 'center' });
    doc.setFont('helvetica', 'normal');
    doc.text('Consultoria Especializada em Eficiencia Energetica', pageWidth / 2, pageHeight - 20, { align: 'center' });
// ============================================
    // PÃGINA 2: SUMÃRIO EXECUTIVO
    // ============================================
    doc.addPage();
    
    // CabeÃ§alho da pÃ¡gina
    doc.setFillColor(245, 158, 11);
    doc.rect(0, 0, pageWidth, 15, 'F');
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('SUMARIO EXECUTIVO', margin, 10);
    
    // SubtÃ­tulo
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100, 116, 139);
    doc.text('Visao Geral e Indicadores-Chave de Performance (KPIs)', margin, 25);
    
    let yPos = 35;
    
    // Box de destaque
    doc.setFillColor(255, 251, 235);
    doc.setDrawColor(245, 158, 11);
    doc.setLineWidth(1.5);
    doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'FD');
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(146, 64, 14);
    doc.text('PRINCIPAIS CONCLUSÃ•ES', margin + 5, yPos + 7);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(69, 26, 3);
    const conclusaoTexto = `Este relatÃ³rio apresenta uma anÃ¡lise detalhada do consumo energÃ©tico de sua residÃªncia, identificando os principais pontos de consumo e oportunidades de otimizaÃ§Ã£o. Os dados foram coletados atraves de simulaÃ§Ã£o baseada em padrÃµes reais de uso domestico.`;
    const conclusaoLines = doc.splitTextToSize(conclusaoTexto, pageWidth - 2 * margin - 10);
    doc.text(conclusaoLines, margin + 5, yPos + 13);
    
    doc.setFont('helvetica', 'bold');
    doc.text(`Tarifa aplicada: R$ ${tarifa.toFixed(3)}/kWh`, margin + 5, yPos + 30);
    
    yPos += 45;
    
    // TÃ­tulo dos indicadores
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text('INDICADORES PRINCIPAIS', margin, yPos);
    
    yPos += 8;
    
    // Cards de mÃ©tricas (2x2)
    const cardWidth = (pageWidth - 2 * margin - 10) / 2;
    const cardHeight = 30;
    const cardGap = 5;
    
    // Card 1: Consumo Total
    doc.setFillColor(240, 253, 244);
    doc.setDrawColor(134, 239, 172);
    doc.setLineWidth(0.5);
    doc.rect(margin, yPos, cardWidth, cardHeight, 'FD');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(22, 101, 52);
    doc.text('CONSUMO TOTAL MENSAL', margin + cardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(18);
    doc.setTextColor(21, 128, 61);
    doc.text(`${totalKwhCasa.toFixed(2)} kWh`, margin + cardWidth / 2, yPos + 17, { align: 'center' });
    doc.setFontSize(7);
    doc.text('Estimativa para 30 dias', margin + cardWidth / 2, yPos + 23, { align: 'center' });
    
    // Card 2: Custo Total
    doc.setFillColor(255, 251, 235);
    doc.setDrawColor(253, 224, 71);
    doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'FD');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(146, 64, 14);
    doc.text('CUSTO TOTAL MENSAL', margin + cardWidth + cardGap + cardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(18);
    doc.setTextColor(180, 83, 9);
    doc.text(money(totalCustoCasa), margin + cardWidth + cardGap + cardWidth / 2, yPos + 17, { align: 'center' });
    doc.setFontSize(7);
    doc.text('Valor estimado na conta de luz', margin + cardWidth + cardGap + cardWidth / 2, yPos + 23, { align: 'center' });
    
    yPos += cardHeight + cardGap;
    
    // Card 3: Ambientes
    doc.setFillColor(239, 246, 255);
    doc.setDrawColor(147, 197, 253);
    doc.rect(margin, yPos, cardWidth, cardHeight, 'FD');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text('AMBIENTES MONITORADOS', margin + cardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(18);
    doc.setTextColor(29, 78, 216);
    doc.text('5', margin + cardWidth / 2, yPos + 17, { align: 'center' });
    doc.setFontSize(7);
    doc.text('Comodos analisados', margin + cardWidth / 2, yPos + 23, { align: 'center' });
    
    // Card 4: Total Aparelhos
    doc.setFillColor(250, 245, 255);
    doc.setDrawColor(216, 180, 254);
    doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'FD');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(107, 33, 168);
    doc.text('TOTAL DE APARELHOS', margin + cardWidth + cardGap + cardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(18);
    doc.setTextColor(124, 58, 237);
    doc.text(String(totalAparelhosCasa), margin + cardWidth + cardGap + cardWidth / 2, yPos + 17, { align: 'center' });
    doc.setFontSize(7);
    doc.text('Equipamentos cadastrados', margin + cardWidth + cardGap + cardWidth / 2, yPos + 23, { align: 'center' });
    
    yPos += cardHeight + 10;
    
    // Pontos de AtenÃ§Ã£o
    if (pontosAtencao.length > 0) {
      doc.setFillColor(254, 242, 242);
      doc.setDrawColor(239, 68, 68);
      doc.setLineWidth(1.5);
      const boxHeight = 10 + (pontosAtencao.length * 8);
      doc.rect(margin, yPos, pageWidth - 2 * margin, boxHeight, 'FD');
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(153, 27, 27);
      doc.text('PONTOS DE ATENCAO', margin + 5, yPos + 7);
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(127, 29, 29);
      let atencaoY = yPos + 13;
      pontosAtencao.forEach(ponto => {
        const linhas = doc.splitTextToSize(ponto, pageWidth - 2 * margin - 10);
        doc.text(linhas, margin + 5, atencaoY);
        atencaoY += linhas.length * 4;
      });
      
      yPos += boxHeight + 5;
    }
    
    // ProjeÃ§Ã£o Anual
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text('PROJEÃ‡ÃƒO ANUAL', margin, yPos);
    
    yPos += 8;
    
    const smallCardWidth = (pageWidth - 2 * margin - 10) / 3;
    const smallCardHeight = 22;
    
    // Consumo Anual
    doc.setFillColor(248, 250, 252);
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.3);
    doc.rect(margin, yPos, smallCardWidth, smallCardHeight, 'FD');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Consumo Anual', margin + smallCardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text(`${(totalKwhCasa * 12).toFixed(0)} kWh`, margin + smallCardWidth / 2, yPos + 16, { align: 'center' });
    
    // Custo Anual
doc.setFillColor(248, 250, 252);
    doc.setDrawColor(0, 0, 0);
    doc.rect(margin + smallCardWidth + cardGap, yPos, smallCardWidth, smallCardHeight, 'FD');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Custo Anual', margin + smallCardWidth + cardGap + smallCardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text(money(totalCustoCasa * 12), margin + smallCardWidth + cardGap + smallCardWidth / 2, yPos + 16, { align: 'center' });
    
    // MÃ©dia DiÃ¡ria
doc.setFillColor(248, 250, 252);
    doc.setDrawColor(0, 0, 0);
    doc.rect(margin + 2 * (smallCardWidth + cardGap), yPos, smallCardWidth, smallCardHeight, 'FD');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Media Diaria', margin + 2 * (smallCardWidth + cardGap) + smallCardWidth / 2, yPos + 7, { align: 'center' });
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text(`${(totalKwhCasa / 30).toFixed(2)} kWh`, margin + 2 * (smallCardWidth + cardGap) + smallCardWidth / 2, yPos + 16, { align: 'center' });
    
    // RodapÃ© da pÃ¡gina
    doc.setFontSize(8);
    doc.setTextColor(148, 163, 184);
    doc.setFont('helvetica', 'normal');
    doc.text('Relatorio Executivo de Consumo Energetico', margin, pageHeight - 10);
    doc.text('Pagina 2', pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.text(dataAtual, pageWidth - margin, pageHeight - 10, { align: 'right' });
    
    // ============================================
    // PÃGINA 3: ANÃLISE POR CÃ”MODO
    // ============================================
    doc.addPage();
    
    // CabeÃ§alho da pÃ¡gina
    doc.setFillColor(245, 158, 11);
    doc.rect(0, 0, pageWidth, 15, 'F');
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('ANALISE POR COMODO', margin, 10);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100, 116, 139);
    doc.text('Distribuicao de Consumo e Custos por Ambiente', margin, 25);
    
    yPos = 35;
    
    // Tabela de consumo por cÃ´modo
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text('CONSUMO DETALHADO POR COMODO', margin, yPos);
    
    yPos += 8;
    
    // CabeÃ§alho da tabela
    doc.setFillColor(248, 250, 252);
    doc.setDrawColor(226, 232, 240);
    doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'FD');
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(71, 85, 105);
    doc.text('Comodo', margin + 5, yPos + 6);
    doc.text('kWh/mes', margin + 60, yPos + 6, { align: 'right' });
    doc.text('R$/mes', margin + 95, yPos + 6, { align: 'right' });
    doc.text('% Total', margin + 130, yPos + 6, { align: 'right' });
    doc.text('Aparelhos', pageWidth - margin - 5, yPos + 6, { align: 'right' });
    
    yPos += 10;
    
    // Linhas da tabela
    allRooms.forEach((roomData, index) => {
      const custo = roomData.totalKwh * tarifa;
      const perc = totalKwhCasa > 0 ? (roomData.totalKwh / totalKwhCasa * 100).toFixed(1) : '0.0';
      
      if (index % 2 === 0) {
        doc.setFillColor(248, 250, 252);
      } else {
        doc.setFillColor(255, 255, 255);
      }
      doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(15, 23, 42);
      doc.text(roomData.room, margin + 5, yPos + 6);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(16, 185, 129);
      doc.text(`${roomData.totalKwh.toFixed(2)}`, margin + 60, yPos + 6, { align: 'right' });
      
      doc.setTextColor(251, 191, 36);
      doc.text(money(custo), margin + 95, yPos + 6, { align: 'right' });
      
      doc.setTextColor(59, 130, 246);
      doc.text(`${perc}%`, margin + 130, yPos + 6, { align: 'right' });
      
      doc.setTextColor(15, 23, 42);
      doc.text(String(roomData.count), pageWidth - margin - 5, yPos + 6, { align: 'right' });
      
      yPos += 10;
    });
    
    // Linha de total
    doc.setDrawColor(226, 232, 240);
    doc.setLineWidth(0.5);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 2;
    
    doc.setFillColor(245, 158, 11);
    doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('TOTAL GERAL', margin + 5, yPos + 6);
    doc.text(`${totalKwhCasa.toFixed(2)} kWh`, margin + 60, yPos + 6, { align: 'right' });
    doc.text(money(totalCustoCasa), margin + 95, yPos + 6, { align: 'right' });
    doc.text('100%', margin + 130, yPos + 6, { align: 'right' });
    doc.text(String(totalAparelhosCasa), pageWidth - margin - 5, yPos + 6, { align: 'right' });
    
    yPos += 20;
    
    // Ranking dos cÃ´modos
    const roomsRanking = [...allRooms].sort((a, b) => b.totalKwh - a.totalKwh);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(15, 23, 42);
    doc.text('RANKING DE CONSUMO', margin, yPos);
    
    yPos += 8;
    
    roomsRanking.forEach((roomData, index) => {
      if (roomData.totalKwh > 0) {
        const perc = totalKwhCasa > 0 ? (roomData.totalKwh / totalKwhCasa * 100).toFixed(1) : '0.0';
        
        // Barra de progresso
        const barWidth = (pageWidth - 2 * margin - 50) * (roomData.totalKwh / (roomsRanking[0].totalKwh || 1));
        const barColors = [
          [245, 158, 11],  // Laranja
          [59, 130, 246],   // Azul
          [16, 185, 129],   // Verde
          [139, 92, 246],   // Roxo
          [236, 72, 153]    // Rosa
        ];
        
        doc.setFillColor(...barColors[index % 5]);
        doc.rect(margin + 50, yPos, barWidth, 8, 'F');
        
        doc.setDrawColor(226, 232, 240);
        doc.setLineWidth(0.3);
        doc.rect(margin + 50, yPos, pageWidth - 2 * margin - 50, 8, 'D');
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(15, 23, 42);
        doc.text(`${index + 1}. ${roomData.room}`, margin, yPos + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.text(`${perc}%`, pageWidth - margin, yPos + 6, { align: 'right' });
        
        yPos += 12;
      }
    });
    
    yPos += 10;
    
    // Oportunidades de Economia
    doc.setFillColor(236, 253, 245);
    doc.setDrawColor(16, 185, 129);
    doc.setLineWidth(1.5);
    doc.rect(margin, yPos, pageWidth - 2 * margin, 40, 'FD');
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(6, 95, 70);
    doc.text('OPORTUNIDADES DE ECONOMIA', margin + 5, yPos + 8);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(6, 78, 59);
    const economiaTxt = `Com medidas de eficiencia energetica, e possivel economizar em media 15% do consumo total. Isso representa uma economia potencial de ${money(economiaPotencial)}/mes ou ${money(economiaPotencial * 12)}/ano.`;
    const economiaLines = doc.splitTextToSize(economiaTxt, pageWidth - 2 * margin - 10);
    doc.text(economiaLines, margin + 5, yPos + 15);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Dica: Concentre esforÃ§os nos comodos de maior consumo para resultados mais rÃ¡pidos.', margin + 5, yPos + 32);
    
    // RodapÃ©
    doc.setFontSize(8);
    doc.setTextColor(148, 163, 184);
    doc.setFont('helvetica', 'normal');
    doc.text('Relatorio Executivo de Consumo Energetico', margin, pageHeight - 10);
    doc.text('Pagina 3', pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.text(dataAtual, pageWidth - margin, pageHeight - 10, { align: 'right' });
    
    // ============================================
    // PÃGINA 4: TOP 10 APARELHOS E CONCLUSÃƒO
    // ============================================
    doc.addPage();
    
    // CabeÃ§alho da pÃ¡gina
    doc.setFillColor(245, 158, 11);
    doc.rect(0, 0, pageWidth, 15, 'F');
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('TOP 10 APARELHOS', margin, 10);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100, 116, 139);
    doc.text('Equipamentos com Maior Consumo Energtico', margin, 25);
    
    yPos = 35;
    
    if (top10.length > 0) {
      // CabeÃ§alho da tabela
      doc.setFillColor(248, 250, 252);
      doc.setDrawColor(226, 232, 240);
      doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'FD');
      
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(71, 85, 105);
      doc.text('#', margin + 3, yPos + 6);
      doc.text('Aparelho', margin + 12, yPos + 6);
      doc.text('Comodo', margin + 75, yPos + 6);
      doc.text('Potencia', margin + 105, yPos + 6, { align: 'right' });
      doc.text('h/dia', margin + 130, yPos + 6, { align: 'right' });
      doc.text('kWh/mes', margin + 148, yPos + 6, { align: 'right' });
      doc.text('R$/mes', pageWidth - margin - 5, yPos + 6, { align: 'right' });
      
      yPos += 10;
      
      // Linhas dos aparelhos
      top10.forEach((ap, index) => {
        const horasTotais = (ap.horas + (ap.minutos / 60)).toFixed(1);
        
        if (index % 2 === 0) {
          doc.setFillColor(248, 250, 252);
        } else {
          doc.setFillColor(255, 255, 255);
        }
        
        // Destaque para os 3 primeiros
        if (index < 3) {
          doc.setFillColor(255, 251, 235);
        }
        
        doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(251, 191, 36);
        doc.text(`${index + 1}`, margin + 3, yPos + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(15, 23, 42);
        const nomeAparelho = ap.nome.length > 25 ? ap.nome.substring(0, 22) + '...' : ap.nome;
        doc.text(nomeAparelho, margin + 12, yPos + 6);
        
        doc.setTextColor(100, 116, 139);
        doc.text(ap.room, margin + 75, yPos + 6);
        
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(15, 23, 42);
        doc.text(`${ap.potencia}W`, margin + 105, yPos + 6, { align: 'right' });
        
        doc.setFont('helvetica', 'normal');
        doc.text(`${horasTotais}h`, margin + 130, yPos + 6, { align: 'right' });
        
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(16, 185, 129);
        doc.text(`${ap.kwh.toFixed(2)}`, margin + 145, yPos + 6, { align: 'right' });
        
        doc.setTextColor(251, 191, 36);
        doc.text(money(ap.custo), pageWidth - margin - 5, yPos + 6, { align: 'right' });
        
        yPos += 10;
      });
      
      yPos += 10;
      
      // AnÃ¡lise do Top 3
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(15, 23, 42);
      doc.text('ANALISE DO TOP 3', margin, yPos);
      
      yPos += 8;
      
      const top3Total = top10.slice(0, 3).reduce((s, ap) => s + ap.kwh, 0);
      const top3Perc = totalKwhCasa > 0 ? (top3Total / totalKwhCasa * 100).toFixed(1) : '0.0';
      
      doc.setFillColor(254, 242, 242);
      doc.setDrawColor(239, 68, 68);
      doc.setLineWidth(1);
      doc.rect(margin, yPos, pageWidth - 2 * margin, 25, 'FD');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(127, 29, 29);
      const top3Text = `Os 3 aparelhos com maior consumo representam ${top3Perc}% do consumo total da residencia (${top3Total.toFixed(2)} kWh/mes). Focar na otimizacao destes equipamentos pode gerar economia significativa.`;
      const top3Lines = doc.splitTextToSize(top3Text, pageWidth - 2 * margin - 10);
      doc.text(top3Lines, margin + 5, yPos + 7);
      
      yPos += 30;
      
      // RecomendaÃ§Ãµes especÃ­ficas
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(15, 23, 42);
      doc.text('RECOMENDACOES ESPECIFICAS', margin, yPos);
      
      yPos += 8;
      
      const recomendacoes = [];
      
      // Verificar chuveiro elÃ©trico
      const chuveiro = allAparelhos.find(ap => ap.nome.toLowerCase().includes('chuveiro'));
      if (chuveiro && chuveiro.kwh > 50) {
        recomendacoes.push('Considere reduzir o tempo de banho ou usar aquecimento solar para reduzir custos com chuveiro eletrico.');
      }
      
      // Verificar ar-condicionado
      const arCond = allAparelhos.find(ap => ap.nome.toLowerCase().includes('ar-condicionado') || ap.nome.toLowerCase().includes('ar condicionado'));
      if (arCond) {
        recomendacoes.push('Configure o ar-condicionado para 23-24C e use timer para desligar durante a noite.');
      }
      
      // Verificar geladeira
      const geladeira = allAparelhos.find(ap => ap.nome.toLowerCase().includes('geladeira'));
      if (geladeira) {
        recomendacoes.push('Verifique as borrachas de vedacao da geladeira e mantenha-a afastada da parede.');
      }
      
      // RecomendaÃ§Ã£o geral
      recomendacoes.push('Substitua lampadas antigas por LED para economia de ate 80% na iluminacao.');
      recomendacoes.push('Desligue aparelhos da tomada quando nao estiver usando (modo standby consome energia).');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(15, 23, 42);
      
      recomendacoes.forEach(rec => {
        const recLines = doc.splitTextToSize(`â€¢ ${rec}`, pageWidth - 2 * margin - 5);
        doc.text(recLines, margin + 5, yPos);
        yPos += recLines.length * 5 + 2;
      });
      
    } else {
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100, 116, 139);
      doc.text('Nenhum aparelho cadastrado no sistema.', margin, yPos);
    }
    
    // Box de conclusÃ£o final
    yPos = pageHeight - 65;
    
    doc.setFillColor(236, 253, 245);
    doc.setDrawColor(16, 185, 129);
    doc.setLineWidth(1.5);
    doc.rect(margin, yPos, pageWidth - 2 * margin, 45, 'FD');
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(6, 95, 70);
    doc.text('CONCLUSAO E PROXIMOS PASSOS', margin + 5, yPos + 8);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(6, 78, 59);
    const conclusaoFinal = `Este relatorio demonstra que o consumo atual e de ${totalKwhCasa.toFixed(2)} kWh/mes (${money(totalCustoCasa)}/mes). Implementando as recomendacoes sugeridas, voce pode economizar ate ${money(economiaPotencial)}/mes.`;
    const conclusaoFinalLines = doc.splitTextToSize(conclusaoFinal, pageWidth - 2 * margin - 10);
    doc.text(conclusaoFinalLines, margin + 5, yPos + 16);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Proximos passos:', margin + 5, yPos + 28);
    doc.setFont('helvetica', 'normal');
    doc.text('1. Priorize acoes nos equipamentos de maior consumo', margin + 5, yPos + 33);
    doc.text('2. Monitore o consumo mensalmente para acompanhar progressos', margin + 5, yPos + 38);
    
    // RodapÃ© final
    doc.setFontSize(8);
    doc.setTextColor(148, 163, 184);
    doc.setFont('helvetica', 'normal');
    doc.text('Relatorio Executivo de Consumo Energetico', margin, pageHeight - 10);
    doc.text('Pagina 4', pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.text(dataAtual, pageWidth - margin, pageHeight - 10, { align: 'right' });
    
    // Salvar o PDF
    const nomeArquivo = `Relatorio_Executivo_Energia_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(nomeArquivo);
    
    alert('âœ… PDF Executivo gerado com sucesso!');
    
  } catch (error) {
    console.error('Erro ao gerar PDF:', error);
    alert('âŒ Erro ao gerar PDF. Verifique o console para mais detalhes.');
  }
}

// ============================================
// EVENT LISTENERS
// ============================================

roomBtns.forEach(b=>b.addEventListener('click',()=>switchRoom(b.dataset.room)));
btnAddManual.addEventListener('click',()=>addRow('',60,1,1,0));
btnClearRoom.addEventListener('click',()=>{
  if(confirm('Limpar todos os aparelhos neste ambiente?')){
    tbody.innerHTML='';
    updateAll();
  }
});
btnSaveRoom.addEventListener('click',()=>{
  saveRoom(currentRoom);
  alert('âœ… Ambiente salvo localmente.');
});
btnCalcular.addEventListener('click',updateAll);
btnExportCsv.addEventListener('click',exportCSV);
btnResetHours.addEventListener('click',()=>{
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.horas').value=0;
    tr.querySelector('.minutos').value=0;
  });
  updateAll();
});
gerarPDFBtn.addEventListener('click', gerarPDFExecutivo);
tarifaInput.addEventListener('input',()=>{updateAll();updateRelatorio();});
btnToggleGraph.addEventListener('click',()=>{
  graphMode=(graphMode==='kwh'?'reais':'kwh');
  localStorage.setItem('sim_graphMode',graphMode);
  updateCharts();
});

document.getElementById('btnVerRelatorio').addEventListener('click',()=>{
  saveRoom(currentRoom);
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('relatorio').classList.add('active');
  updateRelatorio();
});

document.getElementById('btnVoltarCalc').addEventListener('click',()=>{
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('calculadora').classList.add('active');
});

document.getElementById('btnGerarPDFRelatorio').addEventListener('click', gerarPDFExecutivo);

document.getElementById('btnExportRelatorioCSV').addEventListener('click',exportRelatorioCSV);

// ============================================
// INICIALIZAÃ‡ÃƒO
// ============================================
(function init(){
roomBtns.forEach(b=>{
  if(b.dataset.room===currentRoom){
    b.classList.add('bg-amber-400','text-slate-900');
    b.classList.remove('bg-slate-700');
  }
});
renderPresets(currentRoom);
tbody.innerHTML='';
const saved=loadRoom(currentRoom);
if(saved&&saved.length){
  saved.forEach(r=>addRow(r.nome,r.potencia,r.qtd,r.horas,r.minutos||0));
}else{
  (PRESETS[currentRoom]||[]).forEach(d=>addRow(d.name,d.w,d.q||1,d.h||1,d.m||0));
}
if(graphMode!=='kwh'&&graphMode!=='reais')graphMode='kwh';
btnToggleGraph.innerHTML=(graphMode==='kwh')?'ğŸ“Š Modo: kWh':'ğŸ’° Modo: R$';
updateAll();
updateRelatorio();
})();
</script>
</body>
</html>